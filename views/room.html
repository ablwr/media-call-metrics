<!DOCTYPE html>
<html lang="en">
<head>
	<title>media-call-metrics -- room</title>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type">
  <meta name="viewport" content="width=device-width">
  <link href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <header><h1>welcome to your video call</h1></header>
  <main>
    <hr/>
  </main>
<script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
<script>
  callFrame = window.DailyIframe.createFrame({
    showLeaveButton: true,
    iframeStyle: {
      position: 'fixed',
      width: '80%',
     height: '80%'
    }
  });
  let videoUrl = window.location.pathname.replace("/room/", "")
  callFrame.join({ url: 'https://ablwr.daily.co/' + videoUrl })
</script>
<script type="text/javascript">

async function collection() {
  // We need to collect:
  // videoRecvBitsPerSecond, videoRecvPacketLoss, 
  // videoSendBitsPerSecond, videoSendPacketLoss
  // and timestamp for each user
  let netStats = await callFrame.getNetworkStats();
  let session_id = window.location.pathname.replace("/room/", "");
  // user's session id is their user id!!!!!
  let user_id = callFrame.participants().local.session_id;

  const data = { "session_id": session_id, "user_id": user_id, "logs": JSON.stringify(netStats.stats.latest) };

  fetch("/log-data", {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  })
    .then(res => res.json())
    .then(response => {
      // do nothing, it's fine
    })

}

window.setInterval(function() {
  console.log("collecting some network stats")
  collection();
}, 15000); // 15000 milliseconds or 15 seconds

</script>
</body>
</html>